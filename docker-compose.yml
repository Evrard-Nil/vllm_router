services:
  vllm-router:
    image: nearaidev/vllm-router@sha256:c0f0981adf66a53eca4bb15f9af4dc3e341c07bddee77236acb88566fcef8812
    container_name: vllm-router
    ports:
      - "8001:8001"
    environment:
      - ROUTER_ENV_CONFIG=true
      - ROUTER_HOST=0.0.0.0
      - ROUTER_PORT=8001
      - ROUTER_LOG_LEVEL=info
      - BACKENDS=${BACKENDS}
      - VLLM_BACKENDS=${VLLM_BACKENDS}
      - ROUTING_LOGIC=kvaware
      - DOMAIN_REGISTRATION_ENABLED=true
      - CERTBOT_EMAIL=${CERTBOT_EMAIL}
      - STATIC_IP=${STATIC_IP}
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
      - CLOUDFLARE_ZONE_ID=${CLOUDFLARE_ZONE_ID}
      - DOMAINS=${DOMAINS}
    volumes:
      - /var/run/dstack.sock:/var/run/dstack.sock
      - /var/run/tappd.sock:/var/run/tappd.sock
      - cert-data:/etc/letsencrypt
    networks:
      - vllm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  vllm-network:
    driver: bridge

volumes:
  cert-data:
